<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/app/src/main/java/com/example/myapplication3/BlePeripheralService.kt">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/com/example/myapplication3/BlePeripheralService.kt" />
              <option name="originalContent" value="package com.example.myapplication3&#10;&#10;import android.Manifest&#10;import android.annotation.SuppressLint&#10;import android.app.*&#10;import android.bluetooth.*&#10;import android.bluetooth.le.*&#10;import android.content.Context&#10;import android.content.Intent&#10;import android.content.pm.PackageManager&#10;import android.os.Binder&#10;import android.os.Build&#10;import android.os.IBinder&#10;import android.os.ParcelUuid&#10;import android.util.Log&#10;import androidx.core.app.NotificationCompat&#10;import androidx.core.content.ContextCompat&#10;import java.util.UUID&#10;import java.util.concurrent.ConcurrentHashMap&#10;&#10;@SuppressLint(&quot;MissingPermission&quot;)&#10;class BlePeripheralService : Service() {&#10;&#10;    private val TAG = &quot;BlePeripheralService&quot;&#10;    private val NOTIFICATION_ID = 2001&#10;    private val CHANNEL_ID = &quot;ble_peripheral_channel&quot;&#10;&#10;    // BLE Constants&#10;    private val SERVICE_UUID = UUID.fromString(&quot;6E400001-B5A3-F393-E0A9-E50E24DCCA9E&quot;)&#10;    private val CHARACTERISTIC_UUID_WRITE = UUID.fromString(&quot;00001102-0000-1000-8000-00805F9B34FB&quot;)&#10;    private val CHARACTERISTIC_UUID_NOTIFY = UUID.fromString(&quot;00001103-0000-1000-8000-00805F9B34FB&quot;)&#10;    private val CHARACTERISTIC_UUID_READ = UUID.fromString(&quot;00001104-0000-1000-8000-00805F9B34FB&quot;)&#10;    private val CCCD_UUID = UUID.fromString(&quot;00002902-0000-1000-8000-00805f9b34fb&quot;)&#10;&#10;    private val binder = LocalBinder()&#10;&#10;    // BLE Managers&#10;    private var bluetoothManager: BluetoothManager? = null&#10;    private var bluetoothAdapter: BluetoothAdapter? = null&#10;    private var gattServer: BluetoothGattServer? = null&#10;    private var advertiser: BluetoothLeAdvertiser? = null&#10;&#10;    // State&#10;    var isAdvertising = false&#10;        private set&#10;&#10;    // Data structures&#10;    private val connectedClientMap = ConcurrentHashMap&lt;String, BluetoothDevice&gt;()&#10;&#10;    // Characteristics&#10;    private var writeCharacteristicServer: BluetoothGattCharacteristic? = null&#10;    private var notifyCharacteristicServer: BluetoothGattCharacteristic? = null&#10;    private var readCharacteristicServer: BluetoothGattCharacteristic? = null&#10;&#10;    // Callbacks&#10;    var onAdvertisingStateChanged: ((Boolean) -&gt; Unit)? = null&#10;    var onClientsConnected: ((List&lt;BluetoothDevice&gt;) -&gt; Unit)? = null&#10;    var onLogMessage: ((String) -&gt; Unit)? = null&#10;    var onMessageReceived: ((String, String) -&gt; Unit)? = null // (message, from device address)&#10;&#10;    inner class LocalBinder : Binder() {&#10;        fun getService(): BlePeripheralService = this@BlePeripheralService&#10;    }&#10;&#10;    override fun onCreate() {&#10;        super.onCreate()&#10;        log(&quot; Peripheral Service onCreate() - Service created&quot;)&#10;        bluetoothManager = getSystemService(Context.BLUETOOTH_SERVICE) as BluetoothManager&#10;        bluetoothAdapter = bluetoothManager?.adapter&#10;        log(&quot;✓ Bluetooth Manager initialized&quot;)&#10;        createNotificationChannel()&#10;    }&#10;&#10;    override fun onBind(intent: Intent?): IBinder {&#10;        log(&quot; onBind() - Service bound to activity&quot;)&#10;        return binder&#10;    }&#10;&#10;    override fun onStartCommand(intent: Intent?, flags: Int, startId: Int): Int {&#10;        log(&quot; onStartCommand() - Peripheral Service starting&quot;)&#10;        startForeground(NOTIFICATION_ID, createNotification(&quot;Starting Peripheral Mode...&quot;))&#10;        log(&quot;✓ Service running in foreground with notification&quot;)&#10;        &#10;        // ✅ Automatically start advertising when service starts&#10;        log(&quot;⚙️ Auto-starting advertising...&quot;)&#10;        startPeripheralAdvertising()&#10;        &#10;        return START_STICKY&#10;    }&#10;&#10;    private fun createNotificationChannel() {&#10;        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) {&#10;            log(&quot; createNotificationChannel() - Creating notification channel&quot;)&#10;            val channel = NotificationChannel(&#10;                CHANNEL_ID,&#10;                &quot;BLE Peripheral Service&quot;,&#10;                NotificationManager.IMPORTANCE_LOW&#10;            ).apply {&#10;                description = &quot;Running BLE Peripheral in background&quot;&#10;            }&#10;            val notificationManager = getSystemService(NotificationManager::class.java)&#10;            notificationManager.createNotificationChannel(channel)&#10;            log(&quot;✓ Notification channel created successfully&quot;)&#10;        }&#10;    }&#10;&#10;    private fun createNotification(message: String): Notification {&#10;        log(&quot; createNotification() - Creating notification with message: $message&quot;)&#10;        val notificationIntent = Intent(this, MainActivity::class.java)&#10;        val pendingIntent = PendingIntent.getActivity(&#10;            this,&#10;            0,&#10;            notificationIntent,&#10;            PendingIntent.FLAG_IMMUTABLE&#10;        )&#10;&#10;        return NotificationCompat.Builder(this, CHANNEL_ID)&#10;            .setContentTitle(&quot;BLE Peripheral&quot;)&#10;            .setContentText(message)&#10;            .setSmallIcon(android.R.drawable.stat_notify_sync)&#10;            .setContentIntent(pendingIntent)&#10;            .setOngoing(true)&#10;            .build()&#10;    }&#10;&#10;    private fun updateNotification(message: String) {&#10;        log(&quot; updateNotification() - Updating notification: $message&quot;)&#10;        val notificationManager = getSystemService(NotificationManager::class.java)&#10;        notificationManager.notify(NOTIFICATION_ID, createNotification(message))&#10;    }&#10;&#10;    private fun log(message: String) {&#10;        Log.d(TAG, message)&#10;        onLogMessage?.invoke(message)&#10;    }&#10;&#10;    private fun hasPermission(permission: String): Boolean {&#10;        val granted = ContextCompat.checkSelfPermission(this, permission) == PackageManager.PERMISSION_GRANTED&#10;        if (!granted) {&#10;            log(&quot;⚠️ Permission check failed: $permission&quot;)&#10;        }&#10;        return granted&#10;    }&#10;&#10;    // ============================================&#10;    // PERIPHERAL ADVERTISING&#10;    // ============================================&#10;&#10;    fun startPeripheralAdvertising() {&#10;        log(&quot; startPeripheralAdvertising() - Starting advertising process&quot;)&#10;        &#10;        if (isAdvertising) {&#10;            log(&quot;⚠️ Already advertising, skipping&quot;)&#10;            return&#10;        }&#10;        &#10;        if (!hasPermission(Manifest.permission.BLUETOOTH_ADVERTISE)) {&#10;            log(&quot;❌ BLUETOOTH_ADVERTISE permission missing&quot;)&#10;            return&#10;        }&#10;        &#10;        if (!hasPermission(Manifest.permission.BLUETOOTH_CONNECT)) {&#10;            log(&quot;❌ BLUETOOTH_CONNECT permission missing&quot;)&#10;            return&#10;        }&#10;&#10;        advertiser = bluetoothAdapter?.bluetoothLeAdvertiser&#10;        if (advertiser == null) {&#10;            log(&quot;❌ Failed to get BLE Advertiser from adapter&quot;)&#10;            return&#10;        }&#10;        log(&quot;✓ BLE Advertiser obtained&quot;)&#10;&#10;        if (!setupGattServer()) {&#10;            log(&quot;❌ Failed to setup GATT Server, cannot advertise&quot;)&#10;            return&#10;        }&#10;&#10;        log(&quot;⚙️ Building advertising settings...&quot;)&#10;        val settings = AdvertiseSettings.Builder()&#10;            .setAdvertiseMode(AdvertiseSettings.ADVERTISE_MODE_LOW_LATENCY)&#10;            .setTxPowerLevel(AdvertiseSettings.ADVERTISE_TX_POWER_HIGH)&#10;            .setConnectable(true)&#10;            .build()&#10;&#10;        val data = AdvertiseData.Builder()&#10;            .addServiceUuid(ParcelUuid(SERVICE_UUID)) // Only include service UUID to minimize size&#10;            .build()&#10;&#10;        val scanResponse = AdvertiseData.Builder()&#10;            .setIncludeDeviceName(true) // Put device name in scan response, not main advertising data&#10;            .build()&#10;&#10;        log(&quot; Starting BLE advertising with service UUID: $SERVICE_UUID&quot;)&#10;        updateNotification(&quot;Starting advertising...&quot;)&#10;        advertiser?.startAdvertising(settings, data, scanResponse, advertiseCallback)&#10;    }&#10;&#10;    fun stopPeripheralAdvertising() {&#10;        log(&quot; stopPeripheralAdvertising() - Stopping advertising&quot;)&#10;        if (!isAdvertising) {&#10;            log(&quot;⚠️ Not advertising, nothing to stop&quot;)&#10;            return&#10;        }&#10;        &#10;        advertiser?.stopAdvertising(advertiseCallback)&#10;        isAdvertising = false&#10;        onAdvertisingStateChanged?.invoke(false)&#10;        updateNotification(&quot;Advertising stopped&quot;)&#10;        log(&quot;✓ Advertising stopped successfully&quot;)&#10;    }&#10;&#10;    private fun setupGattServer(): Boolean {&#10;        log(&quot;⚙️ setupGattServer() - Setting up GATT Server&quot;)&#10;        &#10;        if (gattServer != null) {&#10;            log(&quot;✓ GATT Server already running&quot;)&#10;            return true&#10;        }&#10;&#10;        log(&quot; Opening GATT Server...&quot;)&#10;        gattServer = bluetoothManager?.openGattServer(this, gattServerCallback)&#10;        if (gattServer == null) {&#10;            log(&quot;❌ Failed to open GATT Server&quot;)&#10;            return false&#10;        }&#10;        log(&quot;✓ GATT Server opened successfully&quot;)&#10;&#10;        log(&quot; Creating GATT Service with UUID: $SERVICE_UUID&quot;)&#10;        val service = BluetoothGattService(SERVICE_UUID, BluetoothGattService.SERVICE_TYPE_PRIMARY)&#10;&#10;        log(&quot; Creating Write Characteristic (UUID: $CHARACTERISTIC_UUID_WRITE)&quot;)&#10;        writeCharacteristicServer = BluetoothGattCharacteristic(&#10;            CHARACTERISTIC_UUID_WRITE,&#10;            BluetoothGattCharacteristic.PROPERTY_WRITE or BluetoothGattCharacteristic.PROPERTY_WRITE_NO_RESPONSE,&#10;            BluetoothGattCharacteristic.PERMISSION_WRITE&#10;        )&#10;&#10;        log(&quot; Creating Read Characteristic (UUID: $CHARACTERISTIC_UUID_READ)&quot;)&#10;        readCharacteristicServer = BluetoothGattCharacteristic(&#10;            CHARACTERISTIC_UUID_READ,&#10;            BluetoothGattCharacteristic.PROPERTY_READ,&#10;            BluetoothGattCharacteristic.PERMISSION_READ&#10;        )&#10;&#10;        log(&quot; Creating Notify Characteristic (UUID: $CHARACTERISTIC_UUID_NOTIFY)&quot;)&#10;        notifyCharacteristicServer = BluetoothGattCharacteristic(&#10;            CHARACTERISTIC_UUID_NOTIFY,&#10;            BluetoothGattCharacteristic.PROPERTY_READ or BluetoothGattCharacteristic.PROPERTY_NOTIFY,&#10;            BluetoothGattCharacteristic.PERMISSION_READ&#10;        )&#10;&#10;        log(&quot; Adding CCCD descriptor to characteristics&quot;)&#10;        val cccdDescriptor = BluetoothGattDescriptor(&#10;            CCCD_UUID,&#10;            BluetoothGattDescriptor.PERMISSION_READ or BluetoothGattDescriptor.PERMISSION_WRITE&#10;        )&#10;        notifyCharacteristicServer?.addDescriptor(cccdDescriptor)&#10;        readCharacteristicServer?.addDescriptor(cccdDescriptor)&#10;&#10;        log(&quot;➕ Adding characteristics to service&quot;)&#10;        service.addCharacteristic(writeCharacteristicServer)&#10;        service.addCharacteristic(notifyCharacteristicServer)&#10;        service.addCharacteristic(readCharacteristicServer)&#10;&#10;        log(&quot;➕ Adding service to GATT Server&quot;)&#10;        val serviceAdded = gattServer?.addService(service) ?: false&#10;        if (serviceAdded) {&#10;            log(&quot;✅ GATT Service added successfully&quot;)&#10;            return true&#10;        } else {&#10;            log(&quot;❌ Failed to add GATT Service&quot;)&#10;            gattServer?.close()&#10;            gattServer = null&#10;            return false&#10;        }&#10;    }&#10;&#10;    private fun stopGattServer() {&#10;        log(&quot; stopGattServer() - Closing GATT Server&quot;)&#10;        if (gattServer == null) {&#10;            log(&quot;⚠️ GATT Server not running&quot;)&#10;            return&#10;        }&#10;        &#10;        gattServer?.close()&#10;        gattServer = null&#10;        writeCharacteristicServer = null&#10;        notifyCharacteristicServer = null&#10;        connectedClientMap.clear()&#10;        onClientsConnected?.invoke(emptyList())&#10;        log(&quot;✓ GATT Server closed and cleaned up&quot;)&#10;    }&#10;&#10;    // ============================================&#10;    // SEND MESSAGE TO CONNECTED CLIENTS&#10;    // ============================================&#10;&#10;    fun sendMessageToClients(message: String) {&#10;        log(&quot; sendMessageToClients() - Attempting to send message: '$message'&quot;)&#10;        &#10;        if (gattServer == null || notifyCharacteristicServer == null || connectedClientMap.isEmpty()) {&#10;            log(&quot;❌ Cannot send: No clients connected or server not ready&quot;)&#10;            return&#10;        }&#10;        &#10;        log(&quot;✓ Sending message to ${connectedClientMap.size} connected client(s)&quot;)&#10;        val data = message.toByteArray(Charsets.UTF_8)&#10;        log(&quot; Message size: ${data.size} bytes&quot;)&#10;&#10;        notifyCharacteristicServer?.value = data&#10;        connectedClientMap.values.forEachIndexed { index, device -&gt;&#10;            val indicate = (notifyCharacteristicServer!!.properties and BluetoothGattCharacteristic.PROPERTY_INDICATE) != 0&#10;            gattServer?.notifyCharacteristicChanged(device, notifyCharacteristicServer, indicate)&#10;            log(&quot;✓ Message sent to client ${index + 1}: ${device.name ?: device.address}&quot;)&#10;        }&#10;    }&#10;&#10;    // ============================================&#10;    // ADVERTISE CALLBACK&#10;    // ============================================&#10;&#10;    private val advertiseCallback = object : AdvertiseCallback() {&#10;        override fun onStartSuccess(settingsInEffect: AdvertiseSettings) {&#10;            log(&quot;✅ Advertising started successfully!&quot;)&#10;            log(&quot; Mode: ${settingsInEffect.mode}, Timeout: ${settingsInEffect.timeout}ms&quot;)&#10;            isAdvertising = true&#10;            onAdvertisingStateChanged?.invoke(true)&#10;            updateNotification(&quot;Advertising - Waiting for connections&quot;)&#10;        }&#10;&#10;        override fun onStartFailure(errorCode: Int) {&#10;            val errorMsg = when(errorCode) {&#10;                ADVERTISE_FAILED_ALREADY_STARTED -&gt; &quot;Already started&quot;&#10;                ADVERTISE_FAILED_DATA_TOO_LARGE -&gt; &quot;Data too large&quot;&#10;                ADVERTISE_FAILED_FEATURE_UNSUPPORTED -&gt; &quot;Feature unsupported&quot;&#10;                ADVERTISE_FAILED_INTERNAL_ERROR -&gt; &quot;Internal error&quot;&#10;                ADVERTISE_FAILED_TOO_MANY_ADVERTISERS -&gt; &quot;Too many advertisers&quot;&#10;                else -&gt; &quot;Unknown error&quot;&#10;            }&#10;            log(&quot;❌ Advertising failed: Error Code $errorCode ($errorMsg)&quot;)&#10;            isAdvertising = false&#10;            onAdvertisingStateChanged?.invoke(false)&#10;            updateNotification(&quot;Advertising failed: $errorMsg&quot;)&#10;        }&#10;    }&#10;&#10;    // ============================================&#10;    // GATT SERVER CALLBACK&#10;    // ============================================&#10;&#10;    private val gattServerCallback = object : BluetoothGattServerCallback() {&#10;        override fun onConnectionStateChange(device: BluetoothDevice, status: Int, newState: Int) {&#10;            val deviceAddress = device.address&#10;            val deviceName = device.name ?: &quot;Unknown&quot;&#10;            &#10;            when (newState) {&#10;                BluetoothProfile.STATE_CONNECTED -&gt; {&#10;                    log(&quot;✅ Client CONNECTED: $deviceName ($deviceAddress)&quot;)&#10;                    log(&quot; Connection status code: $status&quot;)&#10;                    connectedClientMap[deviceAddress] = device&#10;                    onClientsConnected?.invoke(connectedClientMap.values.toList())&#10;                    updateNotification(&quot;Connected: $deviceName&quot;)&#10;                    log(&quot; Total connected clients: ${connectedClientMap.size}&quot;)&#10;                }&#10;                BluetoothProfile.STATE_DISCONNECTED -&gt; {&#10;                    log(&quot;❌ Client DISCONNECTED: $deviceName ($deviceAddress)&quot;)&#10;                    connectedClientMap.remove(deviceAddress)&#10;                    onClientsConnected?.invoke(connectedClientMap.values.toList())&#10;                    &#10;                    if (connectedClientMap.isEmpty()) {&#10;                        updateNotification(&quot;Advertising - No connections&quot;)&#10;                        log(&quot; No clients connected&quot;)&#10;                    } else {&#10;                        updateNotification(&quot;Connected: ${connectedClientMap.size} clients&quot;)&#10;                        log(&quot; Remaining connected clients: ${connectedClientMap.size}&quot;)&#10;                    }&#10;                }&#10;            }&#10;        }&#10;&#10;        override fun onCharacteristicReadRequest(&#10;            device: BluetoothDevice, &#10;            requestId: Int, &#10;            offset: Int, &#10;            characteristic: BluetoothGattCharacteristic&#10;        ) {&#10;            log(&quot; READ request from ${device.name ?: device.address}&quot;)&#10;            log(&quot; Characteristic UUID: ${characteristic.uuid}, Offset: $offset&quot;)&#10;            &#10;            var responseValue: ByteArray? = null&#10;            var responseStatus = BluetoothGatt.GATT_FAILURE&#10;&#10;            if (characteristic.uuid == CHARACTERISTIC_UUID_READ) {&#10;                val timestamp = System.currentTimeMillis()&#10;                responseValue = &quot;Time: $timestamp&quot;.toByteArray(Charsets.UTF_8)&#10;                responseStatus = BluetoothGatt.GATT_SUCCESS&#10;                log(&quot;✓ Sending read response: Time: $timestamp&quot;)&#10;            } else {&#10;                log(&quot;⚠️ Unknown characteristic read request&quot;)&#10;            }&#10;&#10;            gattServer?.sendResponse(device, requestId, responseStatus, offset, responseValue)&#10;            log(&quot;✓ Read response sent with status: $responseStatus&quot;)&#10;        }&#10;&#10;        override fun onCharacteristicWriteRequest(&#10;            device: BluetoothDevice, &#10;            requestId: Int, &#10;            characteristic: BluetoothGattCharacteristic,&#10;            preparedWrite: Boolean, &#10;            responseNeeded: Boolean, &#10;            offset: Int, &#10;            value: ByteArray?&#10;        ) {&#10;            val deviceAddress = device.address&#10;            val deviceName = device.name ?: deviceAddress&#10;            &#10;            log(&quot;✍️ WRITE request from $deviceName&quot;)&#10;            log(&quot; Characteristic UUID: ${characteristic.uuid}&quot;)&#10;            log(&quot; Data size: ${value?.size ?: 0} bytes, Offset: $offset&quot;)&#10;            log(&quot;⚙️ Response needed: $responseNeeded, Prepared write: $preparedWrite&quot;)&#10;&#10;            var responseStatus = BluetoothGatt.GATT_FAILURE&#10;            if (characteristic.uuid == CHARACTERISTIC_UUID_WRITE || characteristic.uuid == CHARACTERISTIC_UUID_READ) {&#10;                val message = value?.toString(Charsets.UTF_8) ?: &quot;null&quot;&#10;                log(&quot; MESSAGE RECEIVED from $deviceName: '$message'&quot;)&#10;                &#10;                // ✅ Notify UI about received message&#10;                onMessageReceived?.invoke(message, deviceName)&#10;                &#10;                responseStatus = BluetoothGatt.GATT_SUCCESS&#10;                log(&quot;✓ Message processed successfully&quot;)&#10;            } else {&#10;                log(&quot;⚠️ Unknown characteristic write request&quot;)&#10;            }&#10;&#10;            if (responseNeeded) {&#10;                gattServer?.sendResponse(device, requestId, responseStatus, offset, value)&#10;                log(&quot;✓ Write response sent with status: $responseStatus&quot;)&#10;            } else {&#10;                log(&quot;ℹ️ No response needed for this write&quot;)&#10;            }&#10;        }&#10;&#10;        override fun onDescriptorWriteRequest(&#10;            device: BluetoothDevice, &#10;            requestId: Int, &#10;            descriptor: BluetoothGattDescriptor,&#10;            preparedWrite: Boolean, &#10;            responseNeeded: Boolean, &#10;            offset: Int, &#10;            value: ByteArray?&#10;        ) {&#10;            log(&quot; DESCRIPTOR write request from ${device.address}&quot;)&#10;            log(&quot; Descriptor UUID: ${descriptor.uuid}&quot;)&#10;            &#10;            var responseStatus = BluetoothGatt.GATT_FAILURE&#10;            if (descriptor.uuid == CCCD_UUID) {&#10;                responseStatus = BluetoothGatt.GATT_SUCCESS&#10;                when {&#10;                    value.contentEquals(BluetoothGattDescriptor.ENABLE_NOTIFICATION_VALUE) -&gt; {&#10;                        log(&quot; Notifications ENABLED by ${device.address}&quot;)&#10;                        log(&quot; Characteristic: ${descriptor.characteristic.uuid}&quot;)&#10;                    }&#10;                    value.contentEquals(BluetoothGattDescriptor.ENABLE_INDICATION_VALUE) -&gt; {&#10;                        log(&quot; Indications ENABLED by ${device.address}&quot;)&#10;                        log(&quot; Characteristic: ${descriptor.characteristic.uuid}&quot;)&#10;                    }&#10;                    else -&gt; {&#10;                        log(&quot; Notifications/Indications DISABLED by ${device.address}&quot;)&#10;                    }&#10;                }&#10;            }&#10;&#10;            if (responseNeeded) {&#10;                gattServer?.sendResponse(device, requestId, responseStatus, offset, null)&#10;                log(&quot;✓ Descriptor write response sent&quot;)&#10;            }&#10;        }&#10;&#10;        override fun onNotificationSent(device: BluetoothDevice, status: Int) {&#10;            val statusText = if (status == BluetoothGatt.GATT_SUCCESS) &quot;SUCCESS&quot; else &quot;FAILURE ($status)&quot;&#10;            log(&quot; Notification sent to ${device.address}: $statusText&quot;)&#10;        }&#10;    }&#10;&#10;    override fun onDestroy() {&#10;        super.onDestroy()&#10;        log(&quot; onDestroy() - Peripheral Service being destroyed&quot;)&#10;        stopPeripheralAdvertising()&#10;        stopGattServer()&#10;        log(&quot;✓ Service cleanup complete&quot;)&#10;    }&#10;}" />
              <option name="updatedContent" value="package com.example.myapplication3&#10;&#10;import android.Manifest&#10;import android.annotation.SuppressLint&#10;import android.app.*&#10;import android.bluetooth.*&#10;import android.bluetooth.le.*&#10;import android.content.Context&#10;import android.content.Intent&#10;import android.content.pm.PackageManager&#10;import android.os.Binder&#10;import android.os.Build&#10;import android.os.IBinder&#10;import android.os.ParcelUuid&#10;import android.util.Log&#10;import androidx.core.app.NotificationCompat&#10;import androidx.core.content.ContextCompat&#10;import java.util.UUID&#10;import java.util.concurrent.ConcurrentHashMap&#10;&#10;@SuppressLint(&quot;MissingPermission&quot;)&#10;class BlePeripheralService : Service() {&#10;&#10;    private val TAG = &quot;BlePeripheralService&quot;&#10;    private val NOTIFICATION_ID = 2001&#10;    private val CHANNEL_ID = &quot;ble_peripheral_channel&quot;&#10;&#10;    // BLE Constants&#10;    private val SERVICE_UUID = UUID.fromString(&quot;6E400001-B5A3-F393-E0A9-E50E24DCCA9E&quot;)&#10;    private val CHARACTERISTIC_UUID_WRITE = UUID.fromString(&quot;00001102-0000-1000-8000-00805F9B34FB&quot;)&#10;    private val CHARACTERISTIC_UUID_NOTIFY = UUID.fromString(&quot;00001103-0000-1000-8000-00805F9B34FB&quot;)&#10;    private val CHARACTERISTIC_UUID_READ = UUID.fromString(&quot;00001104-0000-1000-8000-00805F9B34FB&quot;)&#10;    private val CCCD_UUID = UUID.fromString(&quot;00002902-0000-1000-8000-00805f9b34fb&quot;)&#10;&#10;    private val binder = LocalBinder()&#10;&#10;    // BLE Managers&#10;    private var bluetoothManager: BluetoothManager? = null&#10;    private var bluetoothAdapter: BluetoothAdapter? = null&#10;    private var gattServer: BluetoothGattServer? = null&#10;    private var advertiser: BluetoothLeAdvertiser? = null&#10;&#10;    // State&#10;    var isAdvertising = false&#10;        private set&#10;&#10;    // Data structures&#10;    private val connectedClientMap = ConcurrentHashMap&lt;String, BluetoothDevice&gt;()&#10;&#10;    // Characteristics&#10;    private var writeCharacteristicServer: BluetoothGattCharacteristic? = null&#10;    private var notifyCharacteristicServer: BluetoothGattCharacteristic? = null&#10;    private var readCharacteristicServer: BluetoothGattCharacteristic? = null&#10;&#10;    // Callbacks&#10;    var onAdvertisingStateChanged: ((Boolean) -&gt; Unit)? = null&#10;    var onClientsConnected: ((List&lt;BluetoothDevice&gt;) -&gt; Unit)? = null&#10;    var onLogMessage: ((String) -&gt; Unit)? = null&#10;    var onMessageReceived: ((String, String) -&gt; Unit)? = null // (message, from device address)&#10;&#10;    inner class LocalBinder : Binder() {&#10;        fun getService(): BlePeripheralService = this@BlePeripheralService&#10;    }&#10;&#10;    override fun onCreate() {&#10;        super.onCreate()&#10;        log(&quot; Peripheral Service onCreate() - Service created&quot;)&#10;        bluetoothManager = getSystemService(Context.BLUETOOTH_SERVICE) as BluetoothManager&#10;        bluetoothAdapter = bluetoothManager?.adapter&#10;        log(&quot;✓ Bluetooth Manager initialized&quot;)&#10;        createNotificationChannel()&#10;    }&#10;&#10;    override fun onBind(intent: Intent?): IBinder {&#10;        log(&quot; onBind() - Service bound to activity&quot;)&#10;        return binder&#10;    }&#10;&#10;    override fun onStartCommand(intent: Intent?, flags: Int, startId: Int): Int {&#10;        log(&quot; onStartCommand() - Peripheral Service starting&quot;)&#10;        startForeground(NOTIFICATION_ID, createNotification(&quot;Starting Peripheral Mode...&quot;))&#10;        log(&quot;✓ Service running in foreground with notification&quot;)&#10;        &#10;        // ✅ Automatically start advertising when service starts&#10;        log(&quot;⚙️ Auto-starting advertising...&quot;)&#10;        startPeripheralAdvertising()&#10;        &#10;        return START_STICKY&#10;    }&#10;&#10;    private fun createNotificationChannel() {&#10;        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) {&#10;            log(&quot; createNotificationChannel() - Creating notification channel&quot;)&#10;            val channel = NotificationChannel(&#10;                CHANNEL_ID,&#10;                &quot;BLE Peripheral Service&quot;,&#10;                NotificationManager.IMPORTANCE_LOW&#10;            ).apply {&#10;                description = &quot;Running BLE Peripheral in background&quot;&#10;            }&#10;            val notificationManager = getSystemService(NotificationManager::class.java)&#10;            notificationManager.createNotificationChannel(channel)&#10;            log(&quot;✓ Notification channel created successfully&quot;)&#10;        }&#10;    }&#10;&#10;    private fun createNotification(message: String): Notification {&#10;        log(&quot; createNotification() - Creating notification with message: $message&quot;)&#10;        val notificationIntent = Intent(this, MainActivity::class.java)&#10;        val pendingIntent = PendingIntent.getActivity(&#10;            this,&#10;            0,&#10;            notificationIntent,&#10;            PendingIntent.FLAG_IMMUTABLE&#10;        )&#10;&#10;        return NotificationCompat.Builder(this, CHANNEL_ID)&#10;            .setContentTitle(&quot;BLE Peripheral&quot;)&#10;            .setContentText(message)&#10;            .setSmallIcon(android.R.drawable.stat_notify_sync)&#10;            .setContentIntent(pendingIntent)&#10;            .setOngoing(true)&#10;            .build()&#10;    }&#10;&#10;    private fun updateNotification(message: String) {&#10;        log(&quot; updateNotification() - Updating notification: $message&quot;)&#10;        val notificationManager = getSystemService(NotificationManager::class.java)&#10;        notificationManager.notify(NOTIFICATION_ID, createNotification(message))&#10;    }&#10;&#10;    private fun log(message: String) {&#10;        Log.d(TAG, message)&#10;        onLogMessage?.invoke(message)&#10;    }&#10;&#10;    private fun hasPermission(permission: String): Boolean {&#10;        val granted = ContextCompat.checkSelfPermission(this, permission) == PackageManager.PERMISSION_GRANTED&#10;        if (!granted) {&#10;            log(&quot;⚠️ Permission check failed: $permission&quot;)&#10;        }&#10;        return granted&#10;    }&#10;&#10;    // ============================================&#10;    // PERIPHERAL ADVERTISING&#10;    // ============================================&#10;&#10;    fun startPeripheralAdvertising() {&#10;        log(&quot; startPeripheralAdvertising() - Starting advertising process&quot;)&#10;        &#10;        if (isAdvertising) {&#10;            log(&quot;⚠️ Already advertising, skipping&quot;)&#10;            return&#10;        }&#10;        &#10;        if (!hasPermission(Manifest.permission.BLUETOOTH_ADVERTISE)) {&#10;            log(&quot;❌ BLUETOOTH_ADVERTISE permission missing&quot;)&#10;            return&#10;        }&#10;        &#10;        if (!hasPermission(Manifest.permission.BLUETOOTH_CONNECT)) {&#10;            log(&quot;❌ BLUETOOTH_CONNECT permission missing&quot;)&#10;            return&#10;        }&#10;&#10;        advertiser = bluetoothAdapter?.bluetoothLeAdvertiser&#10;        if (advertiser == null) {&#10;            log(&quot;❌ Failed to get BLE Advertiser from adapter&quot;)&#10;            return&#10;        }&#10;        log(&quot;✓ BLE Advertiser obtained&quot;)&#10;&#10;        if (!setupGattServer()) {&#10;            log(&quot;❌ Failed to setup GATT Server, cannot advertise&quot;)&#10;            return&#10;        }&#10;&#10;        log(&quot;⚙️ Building advertising settings...&quot;)&#10;        val settings = AdvertiseSettings.Builder()&#10;            .setAdvertiseMode(AdvertiseSettings.ADVERTISE_MODE_LOW_LATENCY)&#10;            .setTxPowerLevel(AdvertiseSettings.ADVERTISE_TX_POWER_HIGH)&#10;            .setConnectable(true)&#10;            .build()&#10;&#10;        val data = AdvertiseData.Builder()&#10;            .addServiceUuid(ParcelUuid(SERVICE_UUID)) // Only include service UUID to minimize size&#10;            .build()&#10;&#10;        val scanResponse = AdvertiseData.Builder()&#10;            .setIncludeDeviceName(true) // Put device name in scan response, not main advertising data&#10;            .build()&#10;&#10;        log(&quot; Starting BLE advertising with service UUID: $SERVICE_UUID&quot;)&#10;        updateNotification(&quot;Starting advertising...&quot;)&#10;        advertiser?.startAdvertising(settings, data, scanResponse, advertiseCallback)&#10;    }&#10;&#10;    fun stopPeripheralAdvertising() {&#10;        log(&quot; stopPeripheralAdvertising() - Stopping advertising&quot;)&#10;        if (!isAdvertising) {&#10;            log(&quot;⚠️ Not advertising, nothing to stop&quot;)&#10;            return&#10;        }&#10;        &#10;        advertiser?.stopAdvertising(advertiseCallback)&#10;        isAdvertising = false&#10;        onAdvertisingStateChanged?.invoke(false)&#10;        updateNotification(&quot;Advertising stopped&quot;)&#10;        log(&quot;✓ Advertising stopped successfully&quot;)&#10;    }&#10;&#10;    private fun setupGattServer(): Boolean {&#10;        log(&quot;⚙️ setupGattServer() - Setting up GATT Server&quot;)&#10;        &#10;        if (gattServer != null) {&#10;            log(&quot;✓ GATT Server already running&quot;)&#10;            return true&#10;        }&#10;&#10;        log(&quot; Opening GATT Server...&quot;)&#10;        gattServer = bluetoothManager?.openGattServer(this, gattServerCallback)&#10;        if (gattServer == null) {&#10;            log(&quot;❌ Failed to open GATT Server&quot;)&#10;            return false&#10;        }&#10;        log(&quot;✓ GATT Server opened successfully&quot;)&#10;&#10;        log(&quot; Creating GATT Service with UUID: $SERVICE_UUID&quot;)&#10;        val service = BluetoothGattService(SERVICE_UUID, BluetoothGattService.SERVICE_TYPE_PRIMARY)&#10;&#10;        log(&quot; Creating Write Characteristic (UUID: $CHARACTERISTIC_UUID_WRITE)&quot;)&#10;        writeCharacteristicServer = BluetoothGattCharacteristic(&#10;            CHARACTERISTIC_UUID_WRITE,&#10;            BluetoothGattCharacteristic.PROPERTY_WRITE or BluetoothGattCharacteristic.PROPERTY_WRITE_NO_RESPONSE,&#10;            BluetoothGattCharacteristic.PERMISSION_WRITE&#10;        )&#10;&#10;        log(&quot; Creating Read Characteristic (UUID: $CHARACTERISTIC_UUID_READ)&quot;)&#10;        readCharacteristicServer = BluetoothGattCharacteristic(&#10;            CHARACTERISTIC_UUID_READ,&#10;            BluetoothGattCharacteristic.PROPERTY_READ,&#10;            BluetoothGattCharacteristic.PERMISSION_READ&#10;        )&#10;&#10;        log(&quot; Creating Notify Characteristic (UUID: $CHARACTERISTIC_UUID_NOTIFY)&quot;)&#10;        notifyCharacteristicServer = BluetoothGattCharacteristic(&#10;            CHARACTERISTIC_UUID_NOTIFY,&#10;            BluetoothGattCharacteristic.PROPERTY_READ or BluetoothGattCharacteristic.PROPERTY_NOTIFY,&#10;            BluetoothGattCharacteristic.PERMISSION_READ&#10;        )&#10;&#10;        log(&quot; Adding CCCD descriptor to characteristics&quot;)&#10;        val cccdDescriptor = BluetoothGattDescriptor(&#10;            CCCD_UUID,&#10;            BluetoothGattDescriptor.PERMISSION_READ or BluetoothGattDescriptor.PERMISSION_WRITE&#10;        )&#10;        notifyCharacteristicServer?.addDescriptor(cccdDescriptor)&#10;        readCharacteristicServer?.addDescriptor(cccdDescriptor)&#10;&#10;        log(&quot;➕ Adding characteristics to service&quot;)&#10;        service.addCharacteristic(writeCharacteristicServer)&#10;        service.addCharacteristic(notifyCharacteristicServer)&#10;        service.addCharacteristic(readCharacteristicServer)&#10;&#10;        log(&quot;➕ Adding service to GATT Server&quot;)&#10;        val serviceAdded = gattServer?.addService(service) ?: false&#10;        if (serviceAdded) {&#10;            log(&quot;✅ GATT Service added successfully&quot;)&#10;            return true&#10;        } else {&#10;            log(&quot;❌ Failed to add GATT Service&quot;)&#10;            gattServer?.close()&#10;            gattServer = null&#10;            return false&#10;        }&#10;    }&#10;&#10;    private fun stopGattServer() {&#10;        log(&quot; stopGattServer() - Closing GATT Server&quot;)&#10;        if (gattServer == null) {&#10;            log(&quot;⚠️ GATT Server not running&quot;)&#10;            return&#10;        }&#10;        &#10;        gattServer?.close()&#10;        gattServer = null&#10;        writeCharacteristicServer = null&#10;        notifyCharacteristicServer = null&#10;        connectedClientMap.clear()&#10;        onClientsConnected?.invoke(emptyList())&#10;        log(&quot;✓ GATT Server closed and cleaned up&quot;)&#10;    }&#10;&#10;    // ============================================&#10;    // SEND MESSAGE TO CONNECTED CLIENTS&#10;    // ============================================&#10;&#10;    fun sendMessageToClients(message: String) {&#10;        log(&quot; sendMessageToClients() - Attempting to send message: '$message'&quot;)&#10;        &#10;        if (gattServer == null || notifyCharacteristicServer == null || connectedClientMap.isEmpty()) {&#10;            log(&quot;❌ Cannot send: No clients connected or server not ready&quot;)&#10;            return&#10;        }&#10;        &#10;        log(&quot;✓ Sending message to ${connectedClientMap.size} connected client(s)&quot;)&#10;        val data = message.toByteArray(Charsets.UTF_8)&#10;        log(&quot; Message size: ${data.size} bytes&quot;)&#10;&#10;        notifyCharacteristicServer?.value = data&#10;        connectedClientMap.values.forEachIndexed { index, device -&gt;&#10;            val indicate = (notifyCharacteristicServer!!.properties and BluetoothGattCharacteristic.PROPERTY_INDICATE) != 0&#10;            gattServer?.notifyCharacteristicChanged(device, notifyCharacteristicServer, indicate)&#10;            log(&quot;✓ Message sent to client ${index + 1}: ${device.name ?: device.address}&quot;)&#10;        }&#10;    }&#10;&#10;    // ============================================&#10;    // ADVERTISE CALLBACK&#10;    // ============================================&#10;&#10;    private val advertiseCallback = object : AdvertiseCallback() {&#10;        override fun onStartSuccess(settingsInEffect: AdvertiseSettings) {&#10;            log(&quot;✅ Advertising started successfully!&quot;)&#10;            log(&quot; Mode: ${settingsInEffect.mode}, Timeout: ${settingsInEffect.timeout}ms&quot;)&#10;            isAdvertising = true&#10;            onAdvertisingStateChanged?.invoke(true)&#10;            updateNotification(&quot;Advertising - Waiting for connections&quot;)&#10;        }&#10;&#10;        override fun onStartFailure(errorCode: Int) {&#10;            val errorMsg = when(errorCode) {&#10;                ADVERTISE_FAILED_ALREADY_STARTED -&gt; &quot;Already started&quot;&#10;                ADVERTISE_FAILED_DATA_TOO_LARGE -&gt; &quot;Data too large&quot;&#10;                ADVERTISE_FAILED_FEATURE_UNSUPPORTED -&gt; &quot;Feature unsupported&quot;&#10;                ADVERTISE_FAILED_INTERNAL_ERROR -&gt; &quot;Internal error&quot;&#10;                ADVERTISE_FAILED_TOO_MANY_ADVERTISERS -&gt; &quot;Too many advertisers&quot;&#10;                else -&gt; &quot;Unknown error&quot;&#10;            }&#10;            log(&quot;❌ Advertising failed: Error Code $errorCode ($errorMsg)&quot;)&#10;            isAdvertising = false&#10;            onAdvertisingStateChanged?.invoke(false)&#10;            updateNotification(&quot;Advertising failed: $errorMsg&quot;)&#10;        }&#10;    }&#10;&#10;    // ============================================&#10;    // GATT SERVER CALLBACK&#10;    // ============================================&#10;&#10;    private val gattServerCallback = object : BluetoothGattServerCallback() {&#10;        override fun onConnectionStateChange(device: BluetoothDevice, status: Int, newState: Int) {&#10;            val deviceAddress = device.address&#10;            val deviceName = device.name ?: &quot;Unknown&quot;&#10;            &#10;            when (newState) {&#10;                BluetoothProfile.STATE_CONNECTED -&gt; {&#10;                    log(&quot;✅ Client CONNECTED: $deviceName ($deviceAddress)&quot;)&#10;                    log(&quot; Connection status code: $status&quot;)&#10;                    connectedClientMap[deviceAddress] = device&#10;                    onClientsConnected?.invoke(connectedClientMap.values.toList())&#10;                    updateNotification(&quot;Connected: $deviceName&quot;)&#10;                    log(&quot; Total connected clients: ${connectedClientMap.size}&quot;)&#10;                }&#10;                BluetoothProfile.STATE_DISCONNECTED -&gt; {&#10;                    log(&quot;❌ Client DISCONNECTED: $deviceName ($deviceAddress)&quot;)&#10;                    connectedClientMap.remove(deviceAddress)&#10;                    onClientsConnected?.invoke(connectedClientMap.values.toList())&#10;                    &#10;                    if (connectedClientMap.isEmpty()) {&#10;                        updateNotification(&quot;Advertising - No connections&quot;)&#10;                        log(&quot; No clients connected&quot;)&#10;                    } else {&#10;                        updateNotification(&quot;Connected: ${connectedClientMap.size} clients&quot;)&#10;                        log(&quot; Remaining connected clients: ${connectedClientMap.size}&quot;)&#10;                    }&#10;                }&#10;            }&#10;        }&#10;&#10;        override fun onCharacteristicReadRequest(&#10;            device: BluetoothDevice, &#10;            requestId: Int, &#10;            offset: Int, &#10;            characteristic: BluetoothGattCharacteristic&#10;        ) {&#10;            log(&quot; READ request from ${device.name ?: device.address}&quot;)&#10;            log(&quot; Characteristic UUID: ${characteristic.uuid}, Offset: $offset&quot;)&#10;            &#10;            var responseValue: ByteArray? = null&#10;            var responseStatus = BluetoothGatt.GATT_FAILURE&#10;&#10;            if (characteristic.uuid == CHARACTERISTIC_UUID_READ) {&#10;                val timestamp = System.currentTimeMillis()&#10;                responseValue = &quot;Time: $timestamp&quot;.toByteArray(Charsets.UTF_8)&#10;                responseStatus = BluetoothGatt.GATT_SUCCESS&#10;                log(&quot;✓ Sending read response: Time: $timestamp&quot;)&#10;            } else {&#10;                log(&quot;⚠️ Unknown characteristic read request&quot;)&#10;            }&#10;&#10;            gattServer?.sendResponse(device, requestId, responseStatus, offset, responseValue)&#10;            log(&quot;✓ Read response sent with status: $responseStatus&quot;)&#10;        }&#10;&#10;        override fun onCharacteristicWriteRequest(&#10;            device: BluetoothDevice, &#10;            requestId: Int, &#10;            characteristic: BluetoothGattCharacteristic,&#10;            preparedWrite: Boolean, &#10;            responseNeeded: Boolean, &#10;            offset: Int, &#10;            value: ByteArray?&#10;        ) {&#10;            val deviceAddress = device.address&#10;            val deviceName = device.name ?: deviceAddress&#10;            &#10;            log(&quot;✍️ WRITE request from $deviceName&quot;)&#10;            log(&quot; Characteristic UUID: ${characteristic.uuid}&quot;)&#10;            log(&quot; Data size: ${value?.size ?: 0} bytes, Offset: $offset&quot;)&#10;            log(&quot;⚙️ Response needed: $responseNeeded, Prepared write: $preparedWrite&quot;)&#10;&#10;            var responseStatus = BluetoothGatt.GATT_FAILURE&#10;            if (characteristic.uuid == CHARACTERISTIC_UUID_WRITE || characteristic.uuid == CHARACTERISTIC_UUID_READ) {&#10;                val message = value?.toString(Charsets.UTF_8) ?: &quot;null&quot;&#10;                log(&quot; MESSAGE RECEIVED from $deviceName: '$message'&quot;)&#10;                &#10;                // ✅ Notify UI about received message&#10;                onMessageReceived?.invoke(message, deviceName)&#10;                &#10;                responseStatus = BluetoothGatt.GATT_SUCCESS&#10;                log(&quot;✓ Message processed successfully&quot;)&#10;            } else {&#10;                log(&quot;⚠️ Unknown characteristic write request&quot;)&#10;            }&#10;&#10;            if (responseNeeded) {&#10;                gattServer?.sendResponse(device, requestId, responseStatus, offset, value)&#10;                log(&quot;✓ Write response sent with status: $responseStatus&quot;)&#10;            } else {&#10;                log(&quot;ℹ️ No response needed for this write&quot;)&#10;            }&#10;        }&#10;&#10;        override fun onDescriptorWriteRequest(&#10;            device: BluetoothDevice, &#10;            requestId: Int, &#10;            descriptor: BluetoothGattDescriptor,&#10;            preparedWrite: Boolean, &#10;            responseNeeded: Boolean, &#10;            offset: Int, &#10;            value: ByteArray?&#10;        ) {&#10;            log(&quot; DESCRIPTOR write request from ${device.address}&quot;)&#10;            log(&quot; Descriptor UUID: ${descriptor.uuid}&quot;)&#10;            &#10;            var responseStatus = BluetoothGatt.GATT_FAILURE&#10;            if (descriptor.uuid == CCCD_UUID) {&#10;                responseStatus = BluetoothGatt.GATT_SUCCESS&#10;                when {&#10;                    value.contentEquals(BluetoothGattDescriptor.ENABLE_NOTIFICATION_VALUE) -&gt; {&#10;                        log(&quot; Notifications ENABLED by ${device.address}&quot;)&#10;                        log(&quot; Characteristic: ${descriptor.characteristic.uuid}&quot;)&#10;                    }&#10;                    value.contentEquals(BluetoothGattDescriptor.ENABLE_INDICATION_VALUE) -&gt; {&#10;                        log(&quot; Indications ENABLED by ${device.address}&quot;)&#10;                        log(&quot; Characteristic: ${descriptor.characteristic.uuid}&quot;)&#10;                    }&#10;                    else -&gt; {&#10;                        log(&quot; Notifications/Indications DISABLED by ${device.address}&quot;)&#10;                    }&#10;                }&#10;            }&#10;&#10;            if (responseNeeded) {&#10;                gattServer?.sendResponse(device, requestId, responseStatus, offset, null)&#10;                log(&quot;✓ Descriptor write response sent&quot;)&#10;            }&#10;        }&#10;&#10;        override fun onNotificationSent(device: BluetoothDevice, status: Int) {&#10;            val statusText = if (status == BluetoothGatt.GATT_SUCCESS) &quot;SUCCESS&quot; else &quot;FAILURE ($status)&quot;&#10;            log(&quot; Notification sent to ${device.address}: $statusText&quot;)&#10;        }&#10;    }&#10;&#10;    override fun onDestroy() {&#10;        super.onDestroy()&#10;        log(&quot; onDestroy() - Peripheral Service being destroyed&quot;)&#10;        stopPeripheralAdvertising()&#10;        stopGattServer()&#10;        log(&quot;✓ Service cleanup complete&quot;)&#10;    }&#10;}" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>